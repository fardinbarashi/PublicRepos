# Modulkontroll
if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) {
    Write-Host "Active Directory module is not available. Please ensure RSAT tools are installed." -ForegroundColor Red
    exit
}

# Sök efter alla Windows-servrar i AD
Write-Host "Fetching all Windows Servers from Active Directory..." -ForegroundColor Green
$servers = Get-ADComputer -Filter {OperatingSystem -like "*Windows Server*"} -Property Name, IPv4Address, OperatingSystem

# Initiera en lista för att spara serverinformation
$serverInfoList = @()

# Kör på varje server
foreach ($server in $servers) {
    $serverName = $server.Name
    $ipAddress = $server.IPv4Address

    Write-Host "Processing $serverName ($ipAddress)" -ForegroundColor Cyan

    try {
        # Kör fjärrkommandon för att hämta roller och features
        $rolesAndFeatures = Invoke-Command -ComputerName $serverName -ScriptBlock {
            Import-Module ServerManager
            Get-WindowsFeature | Where-Object { $_.Installed -eq $true } | Select-Object -Property DisplayName, Installed
        } -ErrorAction Stop

        # Lägg till data i listan
        $serverInfoList += [PSCustomObject]@{
            ComputerName = $serverName
            IPAddress = $ipAddress
            RolesAndFeatures = ($rolesAndFeatures | Select-Object -ExpandProperty DisplayName -ErrorAction SilentlyContinue) -join ", "
        }
    } catch {
        # Hantera fel
        Write-Host "Failed to retrieve data for $serverName. Error: $($_.Exception.Message)" -ForegroundColor Red
        $serverInfoList += [PSCustomObject]@{
            ComputerName = $serverName
            IPAddress = $ipAddress
            RolesAndFeatures = "Failed to retrieve data"
        }
    }
}

# Exportera till CSV
$outputFile = "C:\Temp\WindowsServerRoles.csv"
$serverInfoList | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8 -Force

Write-Host "Server roles and features report generated: $outputFile" -ForegroundColor Green
